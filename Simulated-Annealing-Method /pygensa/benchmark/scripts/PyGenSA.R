#=======================================================================
#   * Section *  # Build figure 1 and table S1 of performance.
#=======================================================================
results.path <- file.path(getwd(), 'DATA', 'results.csv')
output.path <- file.path(getwd(), 'OUTPUT')

# Load packages. 
for (i in c("reshape2", "gplots", "xtable", "RColorBrewer")) {
    tmp <- require(i, character.only = TRUE)
    if(!tmp) {
        warning("Now installing R package ", i, ".\n")
        install.packages(pkgs = i, contriburl='http://cran.r-project.org/src/contrib/')
        require(i, character.only = TRUE)
    }
}
# Generate folder for generated outputs
if (!file.exists(output.path)) {
    dir.create(output.path)
}

# Read in file results.csv generated by workflow.py
if(!file.exists(file.path(results.path))) {
    stop('results.csv file not found')
} else {
    per <- read.table(results.path, header = TRUE, sep = ",", na.string = "nan",
        check.names = FALSE, as.is = TRUE)
}

per$Algorithm[per$Algorithm == "GenSA"] <- "PyGenSA"

# Further processing because some function names are too long, so abbreviations are given as follows:
mapping <- matrix(c("DeVilliersGlasser01", "DVS01",
    "DeVilliersGlasser02", "DVS02",
    "DeflectedCorrugatedSpring", "DCS",
    "ElAttarVidyasagarDutta", "EVD",
    "VenterSobiezcczanskiSobieski", "VSS",
    "RosenbrockModified", "RBM"), ncol=2, byrow = TRUE, dimnames = list(NULL, c("original", "new")))
if(any(mapping[, "new"] %in% per$"Function name")) stop("mapping is not right.")
print(mapping)
for (i in 1:nrow(mapping)) {# i = 1
    per$"Function name"[per$"Function name" == mapping[i, "original"]] <- mapping[i, "new"]
}
unique(per$"Function name")[sapply(unique(per$"Function name"), nchar) > 17]

# Output success rate, and average number of function calls over successful runs (ANFC):
per.latex <- per
colnames(per.latex)[colnames(per.latex) == "Function name"] <- "Testing Function"
colnames(per.latex)[colnames(per.latex) == "Algorithm"] <- "Method"
colnames(per.latex)[colnames(per.latex) == "Average"] <- "ANFC"
per.latex$"Success Rate" <- as.numeric(gsub("%", "", per.latex$"Success Rate"))
per.latex$ANFC <- round(per.latex$ANFC, digits = 1)
per.latex <- per.latex[, c("Testing Function", "Method", "Success Rate", "ANFC")]
suc.rate.tab <- dcast(per.latex, `Testing Function` ~ Method, value.var = "Success Rate")
ANFC.tab <- dcast(per.latex, `Testing Function` ~ Method, value.var = "ANFC")
if("BH-R" %in% colnames(suc.rate.tab)) {
    if(all(suc.rate.tab[, "BH"] == suc.rate.tab[, "BH-R"]) && all(ANFC.tab[, "BH"] == ANFC.tab[, "BH-R"])) {
      cat("BH and BH-R give exactly the same result so BH-R will be removed.\n")
      suc.rate.tab <- suc.rate.tab[, colnames(suc.rate.tab) != "BH-R"]
      ANFC.tab <- ANFC.tab[, colnames(ANFC.tab) != "BH-R"]
    }
}
stopifnot(identical(dimnames(ANFC.tab), dimnames(suc.rate.tab)))
stopifnot(suc.rate.tab$"Testing Function" == ANFC.tab$"Testing Function")
suc.ANFC <- data.frame(`Testing Function` = suc.rate.tab$"Testing Function",
    sapply(colnames(ANFC.tab)[colnames(ANFC.tab) != "Testing Function"], function(x) {# x = "BH"
        paste0(suc.rate.tab[, x], " (", ANFC.tab[, x], ")")
    }), check.names = FALSE, stringsAsFactors = FALSE)

tmp <- formatC(colMeans(suc.rate.tab[, -1]), digits = 3)
cat("The mean of success rate is: \n")
print(paste(names(tmp), paste(tmp, "%", sep = ""), sep = ": ", collapse = "; "))
#[1] "BF:   36%; BH: 62.2%; DE: 72.6%; DE-R: 86.5%; PSO: 35.9%; PSO-R: 68.8%; PyGenSA: 93.4%"


tmp <- formatC(apply(ANFC.tab[, -1], 2, function(x) {median(x[!is.na(x)])}), digits = 1, format = "f")
cat("The median of success rate is: \n")
print(paste(names(tmp), paste(tmp, sep = ""), sep = ": ", collapse = "; "))
#[1] "BF: Inf; BH: 867.5; DE: 1197.2; DE-R: 1663.2; PSO: 3718.5; PSO-R: 13355.2; PyGenSA: 1076.3"

# Output Figure 1.
message(paste0('Generating heatmap figure Figure_1_successRate.pdf to folder: ', output.path))
suc.rate <- as.matrix(suc.rate.tab[, -1])
rownames(suc.rate) <- suc.rate.tab[, "Testing Function"]
pdf(file=file.path(output.path, "Figure_1_successRate.pdf"), h=8, w=7)
heatmap.2(suc.rate, col = colorRampPalette(brewer.pal(6, "Spectral")), Colv=FALSE, Rowv=TRUE, dendrogram = "none", labRow=FALSE,
    keysize = 1.2, density.info = "none", trace = "none", margins = c(8, 5), key.title = "Percentage", key.xlab = "Percentage", main = "Success rate", cexCol = 1.7)
dev.off()

# output Table_S1.txt
message(paste0('Generating table Table_S1.txt to folder: ', output.path))
write.table(suc.ANFC, sep = "\t", file = file.path(output.path, "Table_S1.txt"), col.names = TRUE, row.names = FALSE, quote = FALSE)

